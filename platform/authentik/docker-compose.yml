services:
  server:
    image: ghcr.io/goauthentik/server:2025.10.4
    container_name: authentik-server
    command: server
    restart: unless-stopped
    env_file:
      - /etc/homelab/secrets/authentik.env
    environment:
      AUTHENTIK_POSTGRESQL__HOST: geek-postgres
      AUTHENTIK_POSTGRESQL__USER: authentik
      AUTHENTIK_POSTGRESQL__NAME: authentik
    volumes:
      - /srv/homelab/authentik/media:/media
      - /srv/homelab/authentik/custom-templates:/templates
    networks:
      - geek-infra
    ports:
      - "9000:9000"
      - "9443:9443"

  worker:
    image: ghcr.io/goauthentik/server:2025.10.4
    container_name: authentik-worker
    restart: unless-stopped
    env_file:
      - /etc/homelab/secrets/authentik.env
    environment:
      AUTHENTIK_POSTGRESQL__HOST: geek-postgres
      AUTHENTIK_POSTGRESQL__USER: authentik
      AUTHENTIK_POSTGRESQL__NAME: authentik
    volumes:
      - /srv/homelab/authentik/media:/media
      - /srv/homelab/authentik/custom-templates:/templates
    command: worker
    networks:
      - geek-infra

  outpost-proxy:
    image: ghcr.io/goauthentik/proxy:2025.10.4
    container_name: authentik-outpost
    restart: unless-stopped
    env_file:
      - /etc/homelab/secrets/authentik.env
    environment:
      AUTHENTIK_HOST: http://authentik-server:9000
      AUTHENTIK_HOST_BROWSER: https://auth.johnnyblabs.com
      # Use PostgreSQL for session storage (not in-memory)
      AUTHENTIK_POSTGRESQL__HOST: geek-postgres
      AUTHENTIK_POSTGRESQL__USER: authentik
      AUTHENTIK_POSTGRESQL__NAME: authentik
      # AUTHENTIK_TOKEN comes directly from secrets file
    tmpfs:
      - /dev/shm:rw,size=256m,noexec,nodev,nosuid
    networks:
      - geek-infra
    depends_on:
      - server

    # Do NOT publish ports to the LAN; nginx will talk to it over the docker network.
    # ports:
    #  - "9001:9000"

networks:
  geek-infra:
    external: true
