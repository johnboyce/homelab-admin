---
# nginx Configuration Management Role
# Syncs nginx config from repo to host and validates/reloads in container

- name: Ensure /etc/nginx-docker directory exists
  file:
    path: /etc/nginx-docker
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes
  tags: [nginx, config]

- name: Sync nginx configuration from repo
  synchronize:
    src: "{{ playbook_dir | dirname | dirname }}/platform/ingress/nginx/etc-nginx-docker/"
    dest: /etc/nginx-docker/
    delete: no
    checksum: yes
    archive: yes
    rsync_opts:
      - "--exclude=certs/"
  tags: [nginx, config]
  notify:
    - Test nginx configuration
    - Reload nginx

- name: Set nginx directory permissions
  file:
    path: /etc/nginx-docker
    owner: root
    group: root
    mode: '0755'
    recurse: yes
  become: yes
  tags: [nginx, config]

- name: Ensure certs directory exists with proper permissions
  file:
    path: /etc/nginx-docker/certs
    state: directory
    owner: root
    group: root
    mode: '0700'
  become: yes
  tags: [nginx, config]

- name: Fix certificate file permissions (private keys)
  file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: '0600'
  become: yes
  loop: "{{ query('fileglob', '/etc/nginx-docker/certs/*.key') + query('fileglob', '/etc/nginx-docker/certs/*priv*') }}"
  ignore_errors: yes
  tags: [nginx, config]

- name: Fix public certificate permissions (public certs)
  file:
    path: "{{ item }}"
    owner: root
    group: root
    mode: '0644'
  become: yes
  loop: "{{ query('fileglob', '/etc/nginx-docker/certs/*.crt') + query('fileglob', '/etc/nginx-docker/certs/*.pem') }}"
  ignore_errors: yes
  tags: [nginx, config]

- name: Update nginx managed state fact
  community.general.ini_file:
    path: /etc/ansible/facts.d/homelab.fact
    section: managed
    option: "{{ item.key }}"
    value: "{{ item.value }}"
    mode: '0644'
    create: yes
  become: yes
  loop:
    - { key: nginx, value: "true" }
    - { key: nginx_managed_since, value: "{{ ansible_date_time.iso8601 }}" }
  tags: [nginx, config]
