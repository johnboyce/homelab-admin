---
# Authentik Identity Service Management Role
# Manages Authentik stack (server, worker, outpost)
# Phase 5: Lifecycle management (current: stub)

- name: Check Authentik compose file exists
  stat:
    path: /home/johnb/homelab-admin/platform/authentik/docker-compose.yml
  register: authentik_compose
  tags: [authentik, lifecycle]

- name: Report Authentik status
  debug:
    msg: |
      Authentik Status:
      - Compose file: {{ 'exists' if authentik_compose.stat.exists else 'missing' }}
      - Service: Managed by Ansible (state: present, auto-pull enabled)
      - Server: https://auth.{{ domains.internal_tld }}
      - Public: https://auth.{{ domains.public_tld }}
  when: authentik_compose.stat.exists
  tags: [authentik, lifecycle]

- name: Ensure Authentik stack is running
  community.docker.docker_compose_v2:
    project_src: /home/johnb/homelab-admin/platform/authentik
    state: present
    pull: policy
  become: yes
  tags: [authentik, lifecycle]
