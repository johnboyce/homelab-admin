---
# Authentik Identity Service Role
# Manages Authentik stack (server, worker, outpost-proxy)
# Secrets from /etc/homelab/secrets/authentik.env (root-readable)

- name: Check Authentik secrets file exists
  stat:
    path: /etc/homelab/secrets/authentik.env
  become: yes
  register: authentik_secrets
  tags: [authentik, lifecycle]

- name: Fail if secrets file is missing
  fail:
    msg: |
      /etc/homelab/secrets/authentik.env not found.
      Required variables: AUTHENTIK_SECRET_KEY, AUTHENTIK_POSTGRESQL__PASSWORD,
                          AUTHENTIK_TOKEN, AUTHENTIK_OUTPOST_TOKEN
  when: not authentik_secrets.stat.exists
  tags: [authentik, lifecycle]

- name: Ensure Authentik stack is running
  community.docker.docker_compose_v2:
    project_src: /home/johnb/homelab-admin/platform/authentik
    state: present
    pull: policy
  become: yes
  tags: [authentik, lifecycle]
