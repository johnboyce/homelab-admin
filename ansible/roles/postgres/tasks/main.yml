---
# PostgreSQL Service Management Role
# Manages shared PostgreSQL container (used by Authentik and BookStack)
# Secrets from /etc/homelab/secrets/postgres.env (root-readable)

- name: Check PostgreSQL secrets file exists
  stat:
    path: /etc/homelab/secrets/postgres.env
  become: yes
  register: postgres_secrets
  tags: [postgres, lifecycle]

- name: Fail if secrets file is missing
  fail:
    msg: |
      /etc/homelab/secrets/postgres.env not found.
      Required variables: POSTGRES_PASSWORD
  when: not postgres_secrets.stat.exists
  tags: [postgres, lifecycle]

- name: Ensure PostgreSQL service is running
  community.docker.docker_compose_v2:
    project_src: /home/johnb/homelab-admin/platform/postgres
    state: present
    pull: policy
  become: yes
  tags: [postgres, lifecycle]
