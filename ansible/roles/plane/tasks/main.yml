---
# Plane Project Management Role
# Uses official Plane community deployment at /srv/homelab/plane-official/
# Plane runs its own PostgreSQL, Redis, RabbitMQ, and MinIO (self-contained stack)
# Config: /srv/homelab/plane-official/deployments/cli/community/plane-app/plane.env
# Access: http://plane.geek (via nginx proxy to plane-app-proxy-1:80)

- name: Check Plane deployment directory exists
  stat:
    path: /srv/homelab/plane-official/deployments/cli/community/plane-app
  become: yes
  register: plane_deploy_dir
  tags: [plane, lifecycle]

- name: Fail if Plane is not installed
  fail:
    msg: |
      Plane official deployment not found at /srv/homelab/plane-official/
      Install using the official script:
        cd /srv/homelab && git clone https://github.com/makeplane/plane.git plane-official
        cd plane-official/deployments/cli/community && ./install.sh
      Then update plane.env with APP_DOMAIN=plane.geek
  when: not plane_deploy_dir.stat.exists
  tags: [plane, lifecycle]

- name: Ensure Plane stack is running
  community.docker.docker_compose_v2:
    project_src: /srv/homelab/plane-official/deployments/cli/community/plane-app
    env_files:
      - /srv/homelab/plane-official/deployments/cli/community/plane-app/plane.env
    state: present
  become: yes
  tags: [plane, lifecycle]

- name: Ensure Plane proxy is connected to geek-infra network
  shell: |
    docker network connect geek-infra plane-app-proxy-1 2>/dev/null || true
  become: yes
  changed_when: false
  tags: [plane, lifecycle]

- name: Wait for Plane to be ready
  uri:
    url: http://plane-app-proxy-1:80/
    status_code: [200, 302]
  register: plane_result
  until: plane_result.status in [200, 302]
  retries: 30
  delay: 5
  delegate_to: "{{ inventory_hostname }}"
  tags: [plane, lifecycle]
