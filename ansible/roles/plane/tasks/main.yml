---
# Plane Project Management Role
# Manages Plane stack with shared PostgreSQL, Redis, frontend
# Secrets from /etc/homelab/secrets/plane.env (root-readable)

- name: Check Plane secrets file exists
  stat:
    path: /etc/homelab/secrets/plane.env
  become: yes
  register: plane_secrets
  tags: [plane, lifecycle]

- name: Fail if secrets file is missing
  fail:
    msg: |
      /etc/homelab/secrets/plane.env not found.
      Copy from platform .env:
        sudo cp ~/homelab-admin/platform/plane/.env.example /etc/homelab/secrets/plane.env
        sudo chmod 644 /etc/homelab/secrets/plane.env
      Required variables: PLANE_SECRET_KEY, PLANE_DB_PASSWORD
  when: not plane_secrets.stat.exists
  tags: [plane, lifecycle]

- name: Verify Plane database and user exist
  shell: |
    docker exec geek-postgres psql -U postgres -lqt | cut -d \| -f 1 | grep -qw plane || {
      PGPASSWORD=$(grep POSTGRES_PASSWORD /etc/homelab/secrets/postgres.env | cut -d= -f2)
      export PGPASSWORD
      docker exec geek-postgres psql -U postgres -c "CREATE DATABASE plane;"
      docker exec geek-postgres psql -U postgres -c "CREATE USER plane WITH PASSWORD '$(grep PLANE_DB_PASSWORD /etc/homelab/secrets/plane.env | cut -d= -f2)';"
      docker exec geek-postgres psql -U postgres -c "GRANT ALL PRIVILEGES ON DATABASE plane TO plane;"
    }
  become: yes
  tags: [plane, lifecycle]

- name: Create Plane data directories
  file:
    path: "{{ item }}"
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes
  loop:
    - /srv/homelab/plane/data
    - /srv/homelab/plane/redis
  tags: [plane, lifecycle]

- name: Ensure Plane stack is running
  community.docker.docker_compose_v2:
    project_src: /home/johnb/homelab-admin/platform/plane
    state: present
    pull: always
  become: yes
  tags: [plane, lifecycle]

- name: Wait for Plane API to be ready
  uri:
    url: http://localhost:8000/
    status_code: 200
  register: plane_api_result
  until: plane_api_result.status == 200
  retries: 30
  delay: 2
  tags: [plane, lifecycle]
