---
# Plane Project Management Role
# Manages Plane container with shared PostgreSQL database
# Secrets from /etc/homelab/secrets/plane.env (root-readable)

- name: Check Plane secrets file exists
  stat:
    path: /etc/homelab/secrets/plane.env
  become: yes
  register: plane_secrets
  tags: [plane, lifecycle]

- name: Fail if secrets file is missing
  fail:
    msg: |
      /etc/homelab/secrets/plane.env not found.
      Copy from platform .env:
        sudo cp ~/homelab-admin/platform/plane/.env.example /etc/homelab/secrets/plane.env
        sudo chmod 644 /etc/homelab/secrets/plane.env
      Required variables: PLANE_SECRET_KEY, PLANE_DB_PASSWORD
  when: not plane_secrets.stat.exists
  tags: [plane, lifecycle]

- name: Get PostgreSQL password from secrets file
  shell: grep POSTGRES_PASSWORD /etc/homelab/secrets/postgres.env | cut -d= -f2
  become: yes
  register: postgres_password
  tags: [plane, lifecycle]

- name: Get Plane DB password from secrets file
  shell: grep PLANE_DB_PASSWORD /etc/homelab/secrets/plane.env | cut -d= -f2
  become: yes
  register: plane_db_password
  tags: [plane, lifecycle]

- name: Create Plane database in PostgreSQL
  community.postgresql.postgresql_db:
    name: plane
    state: present
    login_host: localhost
    login_user: postgres
    login_password: "{{ postgres_password.stdout }}"
  become: yes
  tags: [plane, lifecycle]

- name: Create Plane PostgreSQL user
  community.postgresql.postgresql_user:
    name: plane
    password: "{{ plane_db_password.stdout }}"
    db: plane
    state: present
    login_host: localhost
    login_user: postgres
    login_password: "{{ postgres_password.stdout }}"
  become: yes
  tags: [plane, lifecycle]

- name: Grant Plane user database permissions
  community.postgresql.postgresql_privs:
    db: plane
    privs: ALL
    type: database
    obj: plane
    role: plane
    login_host: localhost
    login_user: postgres
    login_password: "{{ postgres_password.stdout }}"
  become: yes
  tags: [plane, lifecycle]

- name: Create Plane data directory
  file:
    path: /srv/homelab/plane/data
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes
  tags: [plane, lifecycle]

- name: Ensure Plane stack is running
  community.docker.docker_compose_v2:
    project_src: /home/johnb/homelab-admin/platform/plane
    state: present
    pull: policy
  become: yes
  tags: [plane, lifecycle]

- name: Wait for Plane to be ready
  uri:
    url: http://localhost:8000/
    status_code: 200
  register: plane_result
  until: plane_result.status == 200
  retries: 10
  delay: 2
  tags: [plane, lifecycle]
